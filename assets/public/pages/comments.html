<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://russell2259.github.io/G99/bulma.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css"
    />
    <link rel="stylesheet" href="/assets/css/main.css" />
    <style>
      body {
          width: 100vw;
          height: 90vh;
      }
    </style>
  </head>

  <body>
    <span class="closeModalPannel"> <i class="fa-solid fa-xmark"></i> </span>
    <script src="https://static1.codehs.com/cdn/latest/chsfirebase/chsfirebase.min.js"></script>
    <div class="comments"></div>
    <div class="post-comment">
      <textarea
        class="textarea"
        placeholder="Add a comment..."
        data-attr="comment-subject"
      ></textarea>
      <br />
      <button class="button is-info" data-func="submit-comment">Post</button>
    </div>
    <script>
      const queryString = window.location.search;
      const urlParams = new URLSearchParams(queryString);
      const gameId = urlParams.get("id");
      firebase.initialize({
        projectName: "GameHub",
      });
      const gamesDB = firebase.database().ref("games");
      const accountsDB = firebase.database().ref("accounts");
      gamesDB.on("value", function (games) {
        accountsDB.on("value", function (accounts) {
          for (let i = games.gameComments[gameId].length - 1; i >= 0; i--) {
            var comment = document.createElement("div");
            comment.innerHTML = `<article class="media"><figure class="media-left"><div class="profile-image" style="background-image: url('${
              accounts[games.gameComments[gameId][i].author - 1].pfp
            }');"></div></figure><div class="media-content"><p><strong class="author">${
              accounts[games.gameComments[gameId][i].author - 1].username
            }</strong> <small class="author">@${accounts[
              games.gameComments[gameId][i].author - 1
            ].username.toLowerCase()}</small></p><p class="comment-subject">${
              games.gameComments[gameId][i].subject
            }</p></div><div class="media-right"><!--<i class="fa-solid fa-share-from-square" data-func="share-comment"></i>--></div></article>`;
            comment.classList = "comment";
            document.querySelector(".comments").appendChild(comment);
          }
          const userId = localStorage.getItem("userId");
          const subject = document.querySelector(
            '[data-attr="comment-subject"]'
          );
          const commentSubmit = document.querySelector(
            '[data-func="submit-comment"]'
          );
          commentSubmit.addEventListener("click", (e) => {
            if (subject.value) {
              var temp_db = games;
              var comment = {
                author: userId,
                subject: subject.value,
              };
              temp_db.gameComments[gameId].push(comment);
              //delete temp_db.gameComments[gameId][2];
              subject.value = "";
              gamesDB.set(temp_db);
              document.querySelector(".comments").innerHTML = "";
              for (let i = games.gameComments[gameId].length - 1; i >= 0; i--) {
                var comment = document.createElement("div");
                comment.innerHTML = `<article class="media"><figure class="media-left"><div class="profile-image" style="background-image: url('${
                  accounts[games.gameComments[gameId][i].author - 1].pfp
                }');"></div></figure><div class="media-content"><p><strong class="author">${
                  accounts[games.gameComments[gameId][i].author - 1].username
                }</strong> <small class="author">@${accounts[
                  games.gameComments[gameId][i].author - 1
                ].username.toLowerCase()}</small></p><p class="comment-subject">${
                  games.gameComments[gameId][i].subject
                }</p></div><div class="media-right"><!--<i class="fa-solid fa-share-from-square" data-func="share-comment"></i>--></div></article>`;
                comment.classList = "comment";
                document.querySelector(".comments").appendChild(comment);
              }
            }
          });
          document
            .querySelector(".closeModalPannel")
            .addEventListener("click", (e) => {
              window.parent.document
                .querySelector('[data-func="open-comments"]')
                .querySelectorAll("svg")[0]
                .classList.remove("hidden");
              window.parent.document
                .querySelector('[data-func="open-comments"]')
                .querySelectorAll("svg")[1]
                .classList.add("hidden");
              window.parent.document
                .querySelector(".commentContainer")
                .classList.add("hidden");
            });
        });
      });
    </script>
  </body>
</html>
